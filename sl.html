<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPACE GLASS - Game</title>
<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#000;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
#gameContainer {
  width:600px;
  height:600px;
  background:#111;
  display:grid;
  grid-template-columns: repeat(4,1fr);
  grid-gap:2px;
  position:relative;
}
.tile {
  background:#222;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  cursor:pointer;
  user-select:none;
  transition:0.2s;
}
#info {
  position:absolute;
  top:-90px;
  width:100%;
  display:flex;
  justify-content:space-between;
  font-size:18px;
}
#leaveBtn {
  margin-top:20px;
  padding:10px 30px;
  background:red;
  border:none;
  font-weight:bold;
  cursor:pointer;
  border-radius:5px;
}
</style>
</head>
<body>

<div id="gameWrapper">
  <div id="info">
    <div>Score: <span id="score">0</span></div>
    <div>Lives: <span id="lives">0</span> â™¥</div>
  </div>
  <div id="gameContainer"></div>
  <button id="leaveBtn">LEAVE</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqJTLjxhZBCsvjrTH_cG0fkXlElG6BqTg",
  authDomain: "tose-ccf8f.firebaseapp.com",
  databaseURL: "https://tose-ccf8f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tose-ccf8f",
  storageBucket: "tose-ccf8f.firebasestorage.app",
  messagingSenderId: "475447495901",
  appId: "1:475447495901:web:9189276a162a3680afdf34"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const email = localStorage.getItem('currentUserEmail');
if(!email){
  setTimeout(()=>window.location.href='index.html',300);
}

let userKey = null;
let score = 0;
let lives = 0;

// Get user key and initial lives
async function initUser(){
  const usersSnap = await get(ref(db,'users'));
  const users = usersSnap.val()||{};
  for(const key in users){
    if(users[key].email === email){
      userKey = key;
      lives = users[key].lives || 0;
      updateUI();
      break;
    }
  }
  if(!userKey) {
    alert('User not found');
    window.location.href='index.html';
  }
}
function updateUI(){
  document.getElementById('score').innerText=score;
  document.getElementById('lives').innerText=lives;
}

await initUser();

// Game grid logic
const container = document.getElementById('gameContainer');
const gridSize = 4;
let tiles=[];

// Initialize tiles
function initTiles(){
  tiles=[];
  for(let i=1;i<gridSize*gridSize;i++) tiles.push(i);
  tiles.push(null); // empty space
  shuffleTiles();
  renderTiles();
}

// Shuffle
function shuffleTiles(){
  for(let i=tiles.length-1;i>0;i--){
    const j = Math.floor(Math.random()*i);
    [tiles[i],tiles[j]]=[tiles[j],tiles[i]];
  }
}

// Render
function renderTiles(){
  container.innerHTML='';
  tiles.forEach((num,index)=>{
    const div = document.createElement('div');
    div.className='tile';
    if(num) div.innerText=num;
    div.addEventListener('click',()=>moveTile(index));
    container.appendChild(div);
  });
}

// Move logic
function moveTile(index){
  const emptyIndex = tiles.indexOf(null);
  const neighbors = [
    emptyIndex-1, emptyIndex+1,
    emptyIndex-gridSize, emptyIndex+gridSize
  ];
  if(neighbors.includes(index)){
    [tiles[index],tiles[emptyIndex]]=[tiles[emptyIndex],tiles[index]];
    score+=10;
    updateUI();
    renderTiles();
    checkGameEnd();
  } else {
    lives--;
    updateUI();
    if(lives<=0) endGame();
  }
}

function checkGameEnd(){
  for(let i=0;i<tiles.length-1;i++){
    if(tiles[i]!==i+1) return;
  }
  endGame(true);
}

async function endGame(win=false){
  alert(win?'You completed the puzzle!':'Game over!');
  // Save score
  if(userKey){
    const timestamp = Date.now();
    await push(ref(db,'highScores/'+userKey),{score,timestamp});
    await update(ref(db,'users/'+userKey),{lives,lives});
    await update(ref(db,'leaderboard/current/'+userKey),{score,timestamp});
  }
  window.location.href='main-menu.html';
}

initTiles();

// Leave button
document.getElementById('leaveBtn').addEventListener('click',()=>endGame());

</script>

</body>
</html>
