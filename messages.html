<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPACE GLASS - Messages</title>
<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:purple;
  color:white;
  display:flex;
  justify-content:center;
}
#container {
  width:500px;
  margin-top:20px;
  padding:20px;
}
#back {
  font-size:20px;
  cursor:pointer;
  margin-bottom:15px;
}
.message {
  padding:10px;
  border-bottom:1px solid #444;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}
.message.unread {
  font-weight:bold;
}
.message.read {
  font-weight:normal;
  opacity:0.7;
}
.message-content {
  margin-top:5px;
  display:none;
  color:#fff;
}
.delete {
  cursor:pointer;
  margin-left:10px;
}
</style>
</head>
<body>

<div id="container">
  <div id="back" onclick="window.location.href='main-menu.html'">‚Ü©Ô∏è Back</div>
  <div id="messagesList">Loading messages...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqJTLjxhZBCsvjrTH_cG0fkXlElG6BqTg",
  authDomain: "tose-ccf8f.firebaseapp.com",
  databaseURL: "https://tose-ccf8f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tose-ccf8f",
  storageBucket: "tose-ccf8f.firebasestorage.app",
  messagingSenderId: "475447495901",
  appId: "1:475447495901:web:9189276a162a3680afdf34"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const email = localStorage.getItem('currentUserEmail');
if(!email){
  setTimeout(()=>window.location.href='index.html',300);
}

let userKey = null;

async function getUserKey(){
  const snap = await ref(db,'users');
  const usersSnap = await new Promise(resolve => {
    onValue(ref(db,'users'), snapshot => resolve(snapshot), {onlyOnce:true});
  });
  const users = usersSnap.val() || {};
  for(const key in users){
    if(users[key].email === email){
      userKey = key;
      break;
    }
  }
}

async function loadMessages(){
  await getUserKey();
  if(!userKey) return alert('User not found');

  const messagesRef = ref(db,'messages/'+userKey);
  const messagesList = document.getElementById('messagesList');

  onValue(messagesRef, snap=>{
    messagesList.innerHTML = '';
    const msgs = snap.val() || {};
    // Sort latest first
    const arr = Object.entries(msgs).sort((a,b)=>b[1].timestamp - a[1].timestamp);
    arr.forEach(([id,msg])=>{
      const div = document.createElement('div');
      div.className = 'message '+(msg.read?'read':'unread');
      div.innerHTML = `
        <span>${msg.subject || 'Message'} (${new Date(msg.timestamp).toLocaleString()})</span>
        <span class="delete">üöÆ</span>
        <div class="message-content">${msg.content || ''}</div>
      `;
      messagesList.appendChild(div);

      const contentDiv = div.querySelector('.message-content');

      // Toggle read / expand
      div.addEventListener('click', e=>{
        if(e.target.classList.contains('delete')) return;
        contentDiv.style.display = contentDiv.style.display==='none'?'block':'none';
        if(!msg.read){
          update(ref(db,'messages/'+userKey+'/'+id), { read:true });
        }
      });

      // Delete
      div.querySelector('.delete').addEventListener('click', async e=>{
        e.stopPropagation();
        if(confirm('Delete this message?')){
          await remove(ref(db,'messages/'+userKey+'/'+id));
        }
      });
    });

    if(arr.length===0) messagesList.innerHTML='No messages.';
  });
}

loadMessages();
</script>

</body>
</html>
