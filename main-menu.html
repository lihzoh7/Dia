<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPACE GLASS - Main Menu</title>
<style>
body {
  margin:0; padding:0; font-family: Arial, sans-serif;
  background: url('https://images.unsplash.com/photo-1549924231-f129b911e442?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
  background-size: cover;
  height:100vh;
  overflow:hidden;
}
#glass {
  position:absolute;
  top:50%; left:50%;
  width:350px; height:350px;
  background: rgba(255,255,255,0.1);
  border-radius:50%;
  transform: translate(-50%, -50%) rotate(15deg);
}
.tabs {
  position:absolute; bottom:50px; width:100%;
  display:flex; justify-content:center; gap:20px;
}
.tab {
  width:100px; height:50px; background:rgba(255,255,255,0.2);
  display:flex; justify-content:center; align-items:center;
  border-radius:8px; cursor:pointer; font-weight:bold; color:white;
}
#logout { position:absolute; top:10px; left:10px; cursor:pointer; font-size:24px; color:white; }
#profile { position:absolute; top:10px; right:10px; cursor:pointer; font-size:24px; color:white; }
#messages { position:absolute; top:10px; right:50px; cursor:pointer; font-size:24px; color:white; }

#medals {
  position:absolute;
  bottom:130px; left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:20px;
  font-size:18px;
  color:white;
}
.medal {
  display:flex; flex-direction:column; align-items:center;
}
.medal span { font-weight:bold; margin-top:5px; }
</style>
</head>
<body>

<div id="glass"></div>

<div id="logout">ðŸ”™</div>
<div id="messages">âœ‰</div>
<div id="profile">ðŸ‘¤</div>

<div class="tabs">
  <div class="tab" id="prizesTab">PRIZES</div>
  <div class="tab" id="scoresTab">SCORES</div>
  <div class="tab" id="playTab">PLAY</div>
  <div class="tab" id="walletTab">WALLET</div>
</div>

<div id="medals">
  <div class="medal">ðŸ¥‡<span id="goldName">-</span> R<span id="goldAmount">0</span></div>
  <div class="medal">ðŸ¥ˆ<span id="silverName">-</span> R<span id="silverAmount">0</span></div>
  <div class="medal">ðŸ¥‰<span id="bronzeName">-</span> R<span id="bronzeAmount">0</span></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBqJTLjxhZBCsvjrTH_cG0fkXlElG6BqTg",
  authDomain: "tose-ccf8f.firebaseapp.com",
  databaseURL: "https://tose-ccf8f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tose-ccf8f",
  storageBucket: "tose-ccf8f.firebasestorage.app",
  messagingSenderId: "475447495901",
  appId: "1:475447495901:web:9189276a162a3680afdf34",
  measurementId: "G-PWC5R6Q8JD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Logout
document.getElementById('logout').addEventListener('click', () => {
  window.location.href = 'index.html';
});

// Profile
document.getElementById('profile').addEventListener('click', () => {
  window.location.href = 'profile.html';
});

// Messages
document.getElementById('messages').addEventListener('click', () => {
  window.location.href = 'messages.html';
});

// PRIZES tab
document.getElementById('prizesTab').addEventListener('click', () => { window.location.href='prizes.html'; });

// SCORES tab
document.getElementById('scoresTab').addEventListener('click', () => { window.location.href='scores.html'; });

// WALLET tab
document.getElementById('walletTab').addEventListener('click', () => { window.location.href='wallet.html'; });

// PLAY tab logic with live prize & leaderboard check
document.getElementById('playTab').addEventListener('click', async () => {
  try {
    const snapshot = await get(ref(db,'admin/prizes'));
    if(!snapshot.exists()){
      alert('PRIZE NOT SET YET');
      return;
    }
    const data = snapshot.val();
    const now = new Date();
    const day = now.getDay()===0?6:now.getDay()-1; // Sunday=6
    const nowMinutes = now.getHours()*60 + now.getMinutes();

    let currentPrizeValue = 0;
    if(data.schedule && data.schedule[day]){
      for(const game of data.schedule[day]){
        const [fromH, fromM] = game.from.split(':').map(Number);
        const [toH, toM] = game.to.split(':').map(Number);
        let fromMinutes = fromH*60 + fromM;
        let toMinutes = toH*60 + toM + (toH<fromH?1440:0); // overnight
        if(nowMinutes >= fromMinutes && nowMinutes <= toMinutes && game.value > 0){
          currentPrizeValue = game.value;
          break;
        }
      }
    }

    if(currentPrizeValue > 0){
      // Prize exists, allow play
      window.location.href='game.html';
    } else {
      alert('PRIZE NOT SET YET');
    }

  } catch(err){
    alert(err.message);
  }
});

// Live medals display from leaderboard
async function updateMedals(){
  try{
    const prizeSnap = await get(ref(db,'admin/prizes'));
    const leaderboardSnap = await get(ref(db,'leaderboard/current'));

    if(!prizeSnap.exists() || !leaderboardSnap.exists()) return;

    const data = prizeSnap.val();
    const leaderboard = leaderboardSnap.val();

    const now = new Date();
    const day = now.getDay()===0?6:now.getDay()-1;
    const nowMinutes = now.getHours()*60 + now.getMinutes();

    let currentPrizeValue = 0;
    if(data.schedule && data.schedule[day]){
      for(const game of data.schedule[day]){
        const [fromH, fromM] = game.from.split(':').map(Number);
        const [toH, toM] = game.to.split(':').map(Number);
        let fromMinutes = fromH*60 + fromM;
        let toMinutes = toH*60 + toM + (toH<fromH?1440:0);
        if(nowMinutes >= fromMinutes && nowMinutes <= toMinutes && game.value > 0){
          currentPrizeValue = game.value;
          break;
        }
      }
    }

    // Sort top 3
    const players = [];
    for(const uid in leaderboard){
      players.push({uid, score: leaderboard[uid].score});
    }
    players.sort((a,b)=>b.score - a.score);
    const top3 = players.slice(0,3);

    const gold = top3[0] || {};
    const silver = top3[1] || {};
    const bronze = top3[2] || {};

    const goldName = gold.uid; const silverName = silver.uid; const bronzeName = bronze.uid;
    const goldAmount = Math.round(currentPrizeValue*0.65);
    const silverAmount = Math.round(currentPrizeValue*0.25);
    const bronzeAmount = Math.round(currentPrizeValue*0.10);

    document.getElementById('goldName').innerText = goldName || '-';
    document.getElementById('silverName').innerText = silverName || '-';
    document.getElementById('bronzeName').innerText = bronzeName || '-';

    document.getElementById('goldAmount').innerText = goldAmount;
    document.getElementById('silverAmount').innerText = silverAmount;
    document.getElementById('bronzeAmount').innerText = bronzeAmount;

  } catch(err){
    console.log(err);
  }
}

// Initial and live refresh every 5 sec
updateMedals();
setInterval(updateMedals,5000);

</script>
</body>
</html>
